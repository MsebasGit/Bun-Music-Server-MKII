<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Colaboradores</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/js/utilities.js"></script>
</head>
<body>
    <h1 id="song-title">Cargando...</h1>
    <hr>
    <h2>Colaboradores</h2>
    <div id="collaborators-container">
        <!-- Los colaboradores se insertarán aquí -->
    </div>
    <button onclick="window.history.back()" class="btn btn-lavender">Volver</button>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const songTitleElement = document.getElementById('song-title');
        const collaboratorsContainer = document.getElementById('collaborators-container');

        const urlParams = new URLSearchParams(window.location.search);
        const songId = urlParams.get('id_song');

        if (!songId) {
            document.body.innerHTML = '<h1>Error: Se requiere un ID de canción.</h1>';
            return;
        }

        // Get the logged-in user's artist ID to prevent self-deletion
        let loggedInArtistId = null;
        try {
            const response = await fetch('/me/id');
            if (response.ok) {
                const data = await response.json();
                loggedInArtistId = data.id_artist;
            }
        } catch (error) {
            console.error("Error obteniendo el ID del artista logueado:", error);
        }

        async function deleteCollaborator(artistId) {
            const isConfirmed = confirm('¿Estás seguro de que deseas eliminar a este colaborador?');
            if (isConfirmed) {
                try {
                    const response = await fetch(`/artists/${artistId}/songs/${songId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        alert('Colaborador eliminado.');
                        document.getElementById(`collaborator-${artistId}`).remove();
                    } else {
                        const error = await response.json().catch(() => ({ message: 'Error al eliminar.' }));
                        throw new Error(error.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message);
                }
            }
        }

        try {
            // Fetch song details for the title
            const song = await fetchData(`/get/songs/${songId}`);
            songTitleElement.textContent = `Administrar Colaboradores para: ${song.title}`;

            // Fetch collaborators for the song
            const collaborators = await fetchData(`/get/songs/${songId}/artists`);
            
            collaboratorsContainer.innerHTML = '';
            if (collaborators && collaborators.length > 0) {
                const list = document.createElement('ul');
                collaborators.forEach(artist => {
                    const listItem = document.createElement('li');
                    listItem.id = `collaborator-${artist.id_artist}`;
                    
                    let deleteButtonHtml = '';
                    if (loggedInArtistId && Number(artist.id_artist) !== Number(loggedInArtistId)) {
                        deleteButtonHtml = `<button class="btn delete-btn">Eliminar</button>`;
                    }

                    listItem.innerHTML = `
                        <span>${artist.name}</span>
                        ${deleteButtonHtml}
                    `;

                    // Only add click listener if the button exists
                    if (deleteButtonHtml) {
                        listItem.querySelector('button').onclick = () => deleteCollaborator(artist.id_artist);
                    }
                    list.appendChild(listItem);
                });
                collaboratorsContainer.appendChild(list);
            } else {
                collaboratorsContainer.innerHTML = '<p>No hay otros colaboradores para administrar en esta canción.</p>';
            }

        } catch (error) {
            console.error('Error al cargar datos:', error);
            document.body.innerHTML = '<h1>Error al cargar la página.</h1>';
        }
    });
</script>
</body>
</html>
