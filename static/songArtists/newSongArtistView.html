<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Añadir Colaborador</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/js/utilities.js"></script>
</head>

<body>
    <form action="/songs/artists/new" method="post" class="form-grid">
        <div class="form-group">
            <label for="id_song">Canción</label>
            <select id="id_song"> <!-- El atributo name se elimina, es solo para mostrar -->
                <option disabled selected>Cargando canción...</option>
            </select>
        </div>
        <hr>

        <div class="form-group">
            <label for="id_artist">Artista a Añadir</label>
            <select id="id_artist" name="id_artist">
                <option disabled selected>Cargando artistas...</option>
            </select>
        </div>
        <hr>

        <input type="submit" value="Añadir Colaborador" class="btn btn-submit">
    </form>
    <button onclick="window.history.back()" class="btn btn-browse">
        Volver...
    </button>
</body>
<script>
    function populateSelect(selectElement, items, valueKey, textKey, placeholder) {
        let optionsHTML = `<option disabled selected>${placeholder}</option>`;
        if (items && items.length > 0) {
            items.forEach(item => {
                optionsHTML += `<option value="${item[valueKey]}">${item[textKey]}</option>`;
            });
        } else {
            optionsHTML += '<option disabled>No hay artistas para añadir</option>';
        }
        selectElement.innerHTML = optionsHTML;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const slcArtist = document.getElementById("id_artist");
        const slcSong = document.getElementById("id_song");
        const submitButton = document.querySelector('input[type="submit"]');
        const form = document.querySelector('form');

        const urlParams = new URLSearchParams(window.location.search);
        const songId = urlParams.get('id_song');

        if (!songId) {
            document.body.innerHTML = '<h1>Error: Se requiere un ID de canción.</h1><p>Por favor, añade un colaborador desde la vista de "Mis Canciones".</p><button onclick="window.location.href=\'/me/songs\'">Ir a Mis Canciones</button>';
            return;
        }

        // Añadir el ID de la canción como un campo oculto para que se envíe con el formulario.
        const hiddenSongInput = document.createElement('input');
        hiddenSongInput.type = 'hidden';
        hiddenSongInput.name = 'id_song';
        hiddenSongInput.value = songId;
        form.appendChild(hiddenSongInput);
        
        // Deshabilitar el select de la canción, solo es para mostrar información.
        slcSong.disabled = true;

        try {
            // 1. Cargar los detalles de la canción para mostrar su nombre.
            const song = await fetchData(`/get/songs/${songId}`);
            slcSong.innerHTML = `<option>${song.title}</option>`;

            // 2. Cargar los artistas que NO están relacionados con la canción.
            const artists = await fetchData(`/get/songs/${songId}/not/artists`);
            populateSelect(slcArtist, artists, 'id_artist', 'name', 'Selecciona un artista');

        } catch (error) {
            console.error('Error al cargar datos:', error);
            slcArtist.innerHTML = '<option disabled selected>Error al cargar artistas</option>';
            slcSong.innerHTML = '<option>Error al cargar la canción</option>';
            submitButton.disabled = true;
        }
    });
</script>

</html>