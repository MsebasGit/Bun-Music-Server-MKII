<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalles del Álbum | Música App</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/js/utilities.js"></script>
</head>
<body>
  <section id="album-details">
    <h1 id="album-title"></h1>

    <button id="play-all-btn" class="btn btn-play btn-lavender" style="display: none;">Reproducir Todas</button>
    <button onclick="window.location.href='/albums'" class="btn btn-lavender">Volver a Álbumes</button>

    <div id="music-player" style="display: none; margin-top: 20px; text-align: center;">
      <h3 id="current-song-title"></h3>
      <audio id="audio-player" controls style="width: 100%;"></audio>
      <div>
        <button id="prev-btn" class="btn btn-lavender">Anterior</button>
        <button id="next-btn" class="btn btn-lavender">Siguiente</button>
      </div>
    </div>

    <h2>Todas las Canciones del álbum</h2>
    <div class="card-container" id="song-list-container"></div>
  </section>

  <script>
    const songContainer = document.getElementById("song-list-container");
    const albumTitleElement = document.getElementById("album-title");
    const cardColors = ['card-blue', 'card-green', 'card-yellow', 'card-red'];
    let musicPlayer;

    const songTemplate = (song, index) => {
      const colorClass = cardColors[index % cardColors.length];
      return `
        <div class="card ${colorClass}" data-song-id="${song.id_song}">
            <a href="/songs/${song.id_song}">
                <img src="${song.cover_path}" alt="Cover art for ${song.title}">
                <h3>${song.title}</h3>
            </a>
        </div>
      `;
    };

    async function loadAlbumDetails(id) {
      if (!id) return;
      try {
        const data = await fetchData(`/get/albums/${id}`);
        albumTitleElement.innerHTML = `${data.name || "Álbum Desconocido"}`;
      } catch (error) {
        albumTitleElement.textContent = "Error al cargar los detalles del álbum";
        console.error("Error al cargar los detalles del álbum:", error.message);
      }
    }

    async function loadAlbumSongs(albumId) {
      if (!albumId) {
        songContainer.innerHTML = '<p>No se pudo determinar el ID del álbum desde la URL.</p>';
        return;
      }
      try {
        const songs = await fetchData(`/get/albums/${albumId}/songs`);
        if (songs && songs.length > 0) {
          songContainer.innerHTML = songs.map((song, index) => songTemplate(song, index)).join('');
          if (musicPlayer) {
            musicPlayer.updateSongs(songs);
          }
        } else {
          songContainer.innerHTML = '<p>Este álbum no tiene canciones.</p>';
          if (musicPlayer) {
            musicPlayer.updateSongs([]);
          }
        }
      } catch (error) {
        songContainer.innerHTML = '<p>Error al cargar las canciones del álbum.</p>';
        console.error("Error al cargar las canciones:", error);
      }
    }

    function initPage() {
      const albumId = getIdFromUrl(-2);

      if (albumId) {
        musicPlayer = new MusicPlayer({
          songs: [],
          playerElementId: 'music-player',
          audioElementId: 'audio-player',
          titleElementId: 'current-song-title',
          prevButtonId: 'prev-btn',
          nextButtonId: 'next-btn',
          playAllButtonId: 'play-all-btn'
        });
        loadAlbumDetails(albumId);
        loadAlbumSongs(albumId);
      } else {
        albumTitleElement.textContent = "Error de URL";
        songContainer.innerHTML = '<p>URL inválida: No se encontró el ID del álbum.</p>';
      }
    }

    initPage();
  </script>

</body>

</html>