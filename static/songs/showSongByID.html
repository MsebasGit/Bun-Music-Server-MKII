<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de la Canción</title>
    <script src="/js/utilities.js"></script>
</head>
<style>
    body {
        display: flex;
        font-family: sans-serif;
    }
    .main-content {
        flex: 3;
        padding: 20px;
    }
    .sidebar-content {
        flex: 1;
        padding: 20px;
        border-left: 1px solid #ccc;
        height: 100vh;
        overflow-y: auto;
    }
    form {
        margin: auto;
        padding: 1vw 1vh;
        min-width: 98.75%;
        max-width: none;
        width: 80%;
        display: inline-flex;
    }

    label {
        padding-top: 1.75vh;
    }

    .Container {
        width: fit-content;
        display: flex;
    }

    .Container p {
        size: 1vh;
    }

    .Box img {
        padding: 1vw;
        width: 100%;
        align-self: center;
    }

    .Box {
        width: fit-content;
        margin: 20px;
    }

    audio {
        width: 100%;
    }

    .all-songs-section h2 {
        margin-top: 0;
    }

    .song-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        text-decoration: none;
        color: inherit;
    }
    .current-song {
        background-color: #eee;
    }

    .song-item img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        margin-right: 15px;
        border-radius: 5px;
    }

    .song-item-info h4 {
        margin: 0 0 5px 0;
        font-size: 16px;
    }

    .song-item-info p {
        margin: 0;
        font-size: 14px;
        color: #555;
    }

    .main-song-cover {
        width: 300px;
        height: 300px;
        object-fit: cover;
        border-radius: 10px;
    }
</style>

<body>
    <div class="main-content">
        <div id="Contenedor-Canciones">
        </div>
        <div class="container">

            <div class="actions-bar">
                <div class="like-section">
                    <form id="likeForm" method="POST">
                        <input type="hidden" name="id_song" id="id_song_like">
                        <button type="submit">
                            <img id="like-icon" src="/img/assets/liked-songs.png" alt="Like Icon" class="liked-icon">
                        </button>
                        <label>Likes: <span id="likes-count">0</span></label>
                    </form>
                </div>
                <div class="playlist-section">
                    <form action="" method="post" id="formulario">
                        <label for="id_playlist"></label>
                        <select type="number" id="id_playlist" name="id_playlist">
                            <option disabled selected>Selecciona una playlist</option>
                        </select>
                        <input type="hidden" name="id_song" id="id_song_playlist">
                        <button type="submit">
                            Añadir a playlist
                        </button>
                    </form>
                </div>
            </div>

            <div class="comments-section">
                <h2>Comentarios</h2>
                <form id="commentForm" action="/comments/new" method="POST">
                    <input type="hidden" name="id_song" id="id_song_comment">
                    <textarea name="comment_text" placeholder="Añade un comentario..." required></textarea>
                    <button class="btn btn-submit" type="submit">Comentar</button>
                </form>

                <div id="comments-container">
                    <!-- Los comentarios se cargarán aquí -->
                </div>
            </div>

        </div>
    </div>
    <div class="sidebar-content">
        <div class="all-songs-section">
            <h2>Todas las Canciones</h2>
            <div id="all-songs-container">
                <!-- Contenedor que mostrara todas las canciones a la derecha-->
            </div>
        </div>
    </div>

    <script>
        // --- Variables Globales ---
        const container = document.getElementById("Contenedor-Canciones");
        const slcPlaylist = document.getElementById("id_playlist");
        const formData = document.getElementById("formulario");
        const commentForm = document.getElementById("commentForm");
        const likesCountElement = document.getElementById('likes-count');
        const commentsContainer = document.getElementById('comments-container');

        // Extraer el ID de la URL
        const urlParts = location.href.split('/');
        const songId = urlParts[urlParts.length - 1];
        let userId = 0;

        /**
         * Asigna el ID de la canción a los campos ocultos de los formularios.
         */
        function updateFormIDs() {
            document.getElementById('id_song_playlist').value = songId;
            document.getElementById('id_song_like').value = songId;
            document.getElementById('id_song_comment').value = songId;
            formData.action = `/playlists/songs/new/${songId}`;
            commentForm.action = `/comments/new/${songId}`;
        }

        /**
         * Renderiza los detalles de la canción en el contenedor principal.
         */
        function renderSongDetails(song) {
            const albumName = song.album_name || "N/A";
            const albumLink = song.id_album ? `/albums/${song.id_album}/songs` : '#';

            let artistsHtml = "N/A";
            if (song.artist_names && song.artist_ids) {
                const artistNames = song.artist_names.split(',');
                const artistIds = song.artist_ids.split(',');

                artistsHtml = artistNames.map((name, index) => {
                    const id = artistIds[index];
                    return `<a href="/artists/${id}/songs" class="styled-link">${name.trim()}</a>`;
                }).join(', ');
            }

            container.innerHTML = `
            <h1 class="Title">${song.title}</h1>
            <div class="Container">
            <div class="Box">
            <img class="main-song-cover" src="${song.cover_path}" alt="Portada de ${song.title}">
            </div>
            <div class="Box">
            <p><strong>Idioma:</strong> <span>${song.language}</span></p>
            <p><strong>Fecha de Lanzamiento:</strong> <span>${song.release_date}</span></p>
            <p><strong>Género:</strong> <span>${song.genre}</span></p>
            <p><strong>Álbum:</strong> <a href="${albumLink}" class="styled-link">${albumName}</a></p>
            <p><strong>Artista:</strong> ${artistsHtml}</p>
            </div>
            </div>
            <hr>
            <audio controls autoplay>
                <source src="${song.song_path}" type="audio/mpeg">
            </audio>
        `;
        }

        /**
         * Obtiene y renderiza los detalles de la canción.
         */
        async function fetchSongDetails() {
            try {
                const song = await fetchData(`/get/songs/${songId}`);
                renderSongDetails(song);
            } catch (error) {
                console.error("Error al cargar detalles de la canción:", error);
                container.innerHTML = '<p class="error-message">No se pudieron cargar los detalles de la canción.</p>';
            }
        }

        /**
         * Obtiene las playlists a las que la canción NO ha sido añadida y llena el select.
         */
        async function fetchPlaylists() {
            try {
                const playlists = await fetchData(`/get/songs/${songId}/not/playlists`);
                slcPlaylist.innerHTML = '<option disabled selected>Selecciona una playlist</option>'; // Limpiar y poner default
                if (playlists && playlists.length > 0) {
                    playlists.forEach(playlist => {
                        slcPlaylist.innerHTML += `<option value="${playlist.id_playlist}">${playlist.name}</option>`;
                    });
                } else {
                    slcPlaylist.innerHTML += '<option disabled>No hay playlists disponibles</option>';
                }
            } catch (error) {
                console.error("Error al cargar las playlists:", error);
                slcPlaylist.innerHTML += '<option disabled>Error al cargar playlists</option>';
            }
        }

        /**
         * Verifica si la canción actual ya ha recibido "like" y actualiza el formulario.
         */
        async function checkIfLiked() {
            try {
                const data = await fetchData(`/get/me/liked/songs/${songId}`);
                const likeForm = document.getElementById('likeForm');
                const likeButton = likeForm.querySelector('button');

                if (data.is_liked) {
                    likeForm.action = `/unlike/${songId}`;
                    document.getElementById('like-icon').classList.add('liked');
                    document.getElementById('like-icon').classList.remove('unliked');
                } else {
                    likeForm.action = `/like/${songId}`;
                    document.getElementById('like-icon').classList.add('unliked');
                    document.getElementById('like-icon').classList.remove('liked');
                }
            } catch (error) {
                console.error("Error al verificar si la canción tiene like:", error);
            }
        }

        /**
         * Obtiene y muestra la cantidad de likes para una canción.
         */
        async function fetchLikesCount() {
            try {
                const data = await fetchData(`/get/likes/songs/${songId}`);
                likesCountElement.textContent = data.cuantity_of_likes ?? '0';
            } catch (error) {
                console.error('Error al cargar la cantidad de likes:', error);
                likesCountElement.textContent = '?';
            }
        }

        /**
         * Renderiza los comentarios en su contenedor.
         */
        function renderComments(comments) {
            commentsContainer.innerHTML = ''; // Limpiar comentarios anteriores
            if (comments && comments.length > 0) {
                comments.forEach(comment => {
                    const buttons = Number(userId) === comment.id_user ? `
                    <button class="btn edit-btn" data-id="${comment.id_comment}">Editar</button>
                    <button class="btn delete-btn" data-id="${comment.id_comment}">Eliminar</button>
                ` : '';

                    const commentElement = document.createElement('div');
                    commentElement.className = 'comment';
                    commentElement.id = `comment-${comment.id_comment}`;
                    commentElement.innerHTML = `
                    <p>${comment.comment_text}</p>
                    <small>Usuario: ${comment.username} | Creado: ${new Date(comment.creation_date).toLocaleString()}</small>
                    <div class="comment-actions" style="margin-top: 5px;">
                        ${buttons}
                    </div>
                `;
                    commentsContainer.appendChild(commentElement);
                });
            } else {
                commentsContainer.innerHTML = '<p>No hay comentarios todavía.</p>';
            }
        }

        /**
         * Obtiene los comentarios de la canción y los renderiza.
         */
        async function fetchComments() {
            try {
                const comments = await fetchData(`/get/songs/${songId}/comments`);
                renderComments(comments);
            } catch (error) {
                console.error("Error al cargar los comentarios:", error);
                commentsContainer.innerHTML = '<p>No se pudieron cargar los comentarios.</p>';
            }
        }

        /**
         * Obtiene el ID del usuario actual.
         */
        async function fetchUserID() {
            try {
                const data = await fetchData(`/me/id`);
                userId = data.id_user;
            } catch (error) {
                console.error("Error al cargar el ID del usuario:", error);
            }
        }

        /**
         * Carga y renderiza todas las canciones en la barra lateral.
         */
        async function fetchAndRenderAllSongs() {
            const sidebarSongTemplate = (song) => {
                const artists = song.artist_names || 'Artista desconocido';
                return `
                    <a href="/songs/${song.id_song}" class="song-item ${String(song.id_song) === String(songId) ? 'current-song' : ''}">
                        <img src="${song.cover_path}" alt="Cover for ${song.title}">
                        <div class="song-item-info">
                            <h4>${song.title}</h4>
                            <p>${artists}</p>
                        </div>
                    </a>
                `;
            };

            await loadAndRenderGrid('/get/songs', 'all-songs-container', sidebarSongTemplate, 'Error al cargar canciones.');
        }

        /**
         * Función principal para inicializar la página.
         */
        async function init() {
            if (!songId) {
                container.innerHTML = '<p class="error-message">ID de canción no encontrado en la URL.</p>';
                return;
            }
            updateFormIDs();
            await fetchUserID(); // Esperar a tener el UserID antes de renderizar comentarios

            // Cargar datos en paralelo
            Promise.all([
                fetchSongDetails(),
                fetchPlaylists(),
                checkIfLiked(),
                fetchComments(),
                fetchLikesCount(),
                fetchAndRenderAllSongs()
            ]);
        }

        // --- MANEJADORES DE EVENTOS ---

        // Manejar envío de formulario de "like"
        document.getElementById('likeForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            const form = event.target;
            try {
                await fetchData(form.action, {
                    method: 'POST'
                });
                // Actualizar UI después de la operación
                await checkIfLiked();
                await fetchLikesCount();
            } catch (error) {
                console.error('Error en la operación de like:', error);
            }
        });

        // Manejar envío de formulario de añadir a playlist
        formData.addEventListener('submit', async function (event) {
            event.preventDefault();
            const form = event.target;
            const body = new FormData(form);

            try {
                await fetchData(form.action, {
                    method: 'POST',
                    body: body
                });

                alert('Canción añadida a la playlist con éxito.');
                await fetchPlaylists(); // Recargar las playlists
                form.reset();

            } catch (error) {
                console.error('Error al añadir a la playlist:', error);
                alert(error.message);
            }
        });


        // Manejar envío de formulario de comentario
        commentForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const body = new FormData(form);

            try {
                await fetchData(form.action, {
                    method: 'POST',
                    body: body
                });

                form.reset(); // Limpiar el textarea
                await fetchComments(); // Recargar los comentarios

            } catch (error) {
                console.error('Error al enviar el comentario:', error);
                alert(error.message);
            }
        });

        // Delegación de eventos para acciones de comentarios
        commentsContainer.addEventListener('click', async function (event) {
            const target = event.target;

            // Clic en "Editar"
            if (target.classList.contains('edit-btn')) {
                const commentId = target.dataset.id;
                const commentDiv = document.getElementById(`comment-${commentId}`);
                const p = commentDiv.querySelector('p');
                const currentText = p.textContent;
                const actionsDiv = commentDiv.querySelector('.comment-actions');

                actionsDiv.style.display = 'none';
                p.style.display = 'none';

                const editForm = document.createElement('form');
                editForm.className = 'edit-comment-form';
                editForm.dataset.commentId = commentId;
                editForm.innerHTML = `
                <textarea name="comment_text" required>${currentText}</textarea>
                <button type="submit">Actualizar</button>
                <button type="button" class="cancel-edit">Cancelar</button>
            `;
                commentDiv.appendChild(editForm);
            }

            // Clic en "Cancelar"
            if (target.classList.contains('cancel-edit')) {
                const form = target.closest('form');
                const commentDiv = form.closest('.comment');
                commentDiv.querySelector('p').style.display = 'block';
                commentDiv.querySelector('.comment-actions').style.display = 'block';
                form.remove();
            }

            // Clic en "Eliminar"
            if (target.classList.contains('delete-btn')) {
                const commentId = target.dataset.id;
                const isConfirmed = confirm('¿Estás seguro de que quieres eliminar este comentario?');
                if (isConfirmed) {
                    try {
                        await fetchData(`/comments/${commentId}`, {
                            method: 'DELETE'
                        });
                        alert('Comentario eliminado.');
                        document.getElementById(`comment-${commentId}`).remove();
                    } catch (error) {
                        console.error('Error al eliminar el comentario:', error);
                        alert('No se pudo eliminar el comentario.');
                    }
                }
            }
        });

        // Manejar envío del formulario de edición de comentario
        commentsContainer.addEventListener('submit', async function (event) {
            if (event.target.classList.contains('edit-comment-form')) {
                event.preventDefault();
                const form = event.target;
                const commentId = form.dataset.commentId;
                const commentText = form.querySelector('textarea[name="comment_text"]').value;

                try {
                    await fetchData(`/comments/${commentId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            comment_text: commentText
                        })
                    });

                    const commentDiv = document.getElementById(`comment-${commentId}`);
                    const p = commentDiv.querySelector('p');
                    p.textContent = commentText;
                    p.style.display = 'block';
                    commentDiv.querySelector('.comment-actions').style.display = 'block';
                    form.remove();
                    alert('Comentario actualizado.');

                } catch (error) {
                    console.error('Error al actualizar el comentario:', error);
                    alert('No se pudo actualizar el comentario.');
                }
            }
        });

        // Iniciar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);
    </script>

</html>
